name: Windows Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
    - name: Cache vcpkg directory
      uses: actions/cache@v4
      with:
        path: D:/a/ion/ion/vcpkg
        key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}
        restore-keys: |
          vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}-
          vcpkg-${{ runner.os }}-
    - name: Cache builds directory
      uses: actions/cache@v4
      with:
        path: D:/a/ion/ion/builds
        key: build-${{ runner.os }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}
        restore-keys: |
          build-${{ runner.os }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}-
          build-${{ runner.os }}-

    - uses: lukka/get-cmake@latest
    
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgJsonGlob: "./vcpkg.json"
    
    - name: Run CMake
      uses: lukka/run-cmake@v10
      with:
        configurePreset: "ninja-multi-vcpkg"
        buildPreset: "release"

    - name: Create zip archive
      shell: pwsh
      run: |
        $cwd = $env:GITHUB_WORKSPACE
        Set-Location $cwd

        $releaseRel = "builds\\ninja-multi-vcpkg\\Release"
        $zipFullPath = Join-Path $cwd (Join-Path $releaseRel "ion-latest.zip")

        if (Test-Path $zipFullPath) { Remove-Item $zipFullPath -Force }

        $paths = @()

        $ionExeRel = Join-Path $releaseRel "ion-development.exe"
        if (Test-Path $ionExeRel) {
          $paths += $ionExeRel
        }

        $dlls = Get-ChildItem -Path $releaseRel -Filter "*.dll" -File -Recurse -ErrorAction SilentlyContinue
        if ($dlls) {
          $paths += ($dlls | ForEach-Object { $_.FullName.Substring($cwd.Length + 1) })
        }

        if (Test-Path "assets") {
          $paths += "assets"
        }

        if ($paths.Count -eq 0) {
          exit 1
        }

        Compress-Archive -Path $paths -DestinationPath $zipFullPath -Force
    - name: Release built file
      uses: "marvinpinto/action-automatic-releases@latest"
      with:
        repo_token: "${{ secrets.GH_TOKEN }}"
        automatic_release_tag: "latest-windows"
        prerelease: true
        title: "Pre-release Build (Windows)"
        files: |
          builds/ninja-multi-vcpkg/Release/ion-latest-windows.zip
